{
    "Parameters" : {
        "KeyName" : {
            "Description" : "Name of an existing EC2 KeyPair file (.pem) to use to create EC2 instances.  If the file name is foo.pem, specify foo",
            "Type" : "String"   
        },
        "EC2InstanceType" : {
            "Description" : "EC2 instance type, reference this parameter to insure consistency",
            "Type"        : "String",
            "Default"     : "t2.micro",
            "AllowedValues" : [
                "t2.small",
                "t2.micro",
                "t2.medium",
                "m3.medium",
                "m3.large"
            ],
            "ConstraintDescription" : "Must be a valid EC2 instance type"
        }
    },
    "Mappings" : {
        "RegionMap" : {
            "ap-northeast-1" : {
                "AMI" : "ami-383c1956"
            },
            "ap-southeast-1" : {
                "AMI" : "ami-c9b572aa"
            },
            "ap-southeast-2": {
                "AMI" : "ami-48d38c2b"
            },
            "us-east-1" : {
                "AMI" : "ami-60b6c60a"
            },
            "eu-west-1" : {
                "AMI" : "ami-bff32ccc"
            },
            "sa-east-1" : {
                "AMI" : "ami-6817af04"
            },
            "us-west-1" : {
                "AMI" : "ami-d5ea86b5"
            },
            "us-west-2" : {
                "AMI" : "ami-f0091d91"
            }
        }
    },
    
    "Resources" : {
        "EC2Instance" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "KeyName" : { "Ref" : "KeyName" },
                "ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "AMI" ] },
                "InstanceType" : { "Ref" : "EC2InstanceType" },
                "UserData" : { "Fn::Base64" : "80" }    
            }
        },
		
		"JenkinsAutoScalingGroupLaunchConfig" : {
			"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"Properties" : {
				"KeyName" : { "Ref" : "KeyName" },
				"ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "AMI" ] },
				"InstanceType" : { "Ref" : "EC2InstanceType" },
				"Metadata" : {
					"AWS::CloudFormation::Init" : {
						"config" : {
							"packages" : {
							},
							"groups" : {
							},
							"users" : {
							},
							"sources" : {
							},
							"files" : {
							},
							"commands" : {
								"00_install_java" : {
									"command" : "yum -y install java"
								},
								"01_add_jenkins_repo_to_yum_repos" : {
									"command" : "wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo"
								},
								"02_add_jenkins_key_to_system" : {
									"command" : "rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key"
								},
								"03_yum_install_jenkins" : {
									"command" : "yum -y install jenkins"
								},
								"04_start_jenkins_service" : {
									"command" : "service jenkins start"
								},
								"05_enable_jenkins_service_on_startup" : {
									"command" : "chkconfig jenkins on"
								}
							},
							"services" : {
							}
						}
					}
				}
			}
		},
		
		"JenkinsAutoScalingGroup" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"Properties" : {
				"LaunchConfigurationName" : { "Ref" : "JenkinsAutoScalingGroupLaunchConfig" },
				"MinSize" : "0",
				"MaxSize" : "1",
				"DesiredCapacity": "1",
				"HealthCheckGracePeriod" : 60,
				"Tags": [{"Key": "Name", "Value" : "Jenkins", "PropagateAtLaunch" : "true"}]
			}
		}
	},
		
    "Outputs" : {
        "JenkinsURL": {
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "http://",
                        {
                            "Fn::GetAtt": ["EC2Instance", "PublicIp" ]
                        },
                        "/8080"
                    ]
                ]
            },
            "Description" : "URL of the Jenkins instance"
        }
    }
}



